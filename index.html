<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>XR å¼ºåˆ¶HUDç‰ˆ</title>
    <style>
        body { margin: 0; background-color: #000; color: white; font-family: sans-serif; }
        #launcher {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #111; z-index: 10;
        }
        button {
            padding: 20px 50px; font-size: 24px; background: #ff0055; border: none; border-radius: 10px; font-weight: bold; color: white;
        }
        p { color: #aaa; margin-top: 10px; max-width: 80%; text-align: center; }
    </style>
    <!-- å¼•å…¥ Three.js -->
    <script type="importmap">
        { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js" } }
    </script>
</head>
<body>

<div id="launcher">
    <h1>ğŸ¯ HUD é”å®šæ¨¡å¼</h1>
    <p>è¿™ä¸ªç‰ˆæœ¬ä¼šå°†ç²’å­ç›´æ¥ç²˜åœ¨ä½ çš„é•œå¤´ä¸Šã€‚<br>ä¸ç®¡ä½ å¾€å“ªçœ‹ï¼Œå®ƒéƒ½ä¼šè·Ÿç€ä½ ã€‚</p>
    <button id="btn-enter">å¯åŠ¨ AR</button>
</div>

<script type="module">
    import * as THREE from 'three';

    let camera, scene, renderer;
    let hand1, hand2;
    let hudContainer; // è¿™æ˜¯ä¸€ä¸ªæŒ‚åœ¨ç›¸æœºä¸Šçš„å®¹å™¨
    let particles, particleGeo, particleOriginalPos = [];
    const particleCount = 1000;

    document.getElementById('btn-enter').addEventListener('click', onEnter);

    async function onEnter() {
        if (!navigator.xr) return alert("ä¸æ”¯æŒ WebXR");
        try {
            const session = await navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['local'],
                optionalFeatures: ['hand-tracking']
            });
            document.getElementById('launcher').style.display = 'none';
            initThree(session);
        } catch (e) {
            alert("å¯åŠ¨å¤±è´¥: " + e.message);
        }
    }

    function initThree(session) {
        scene = new THREE.Scene();
        scene.background = null; // é€æ˜èƒŒæ™¯

        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.05, 100);
        // ã€å…³é”®æ­¥éª¤ã€‘å¿…é¡»æŠŠ camera åŠ åˆ° scene é‡Œï¼Œå¦åˆ™æŒ‚åœ¨ camera ä¸Šçš„ä¸œè¥¿ä¸ä¼šè¢«æ¸²æŸ“
        scene.add(camera);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.xr.setReferenceSpaceType('local');
        renderer.xr.setSession(session);

        session.addEventListener('end', () => {
            renderer.setAnimationLoop(null);
            document.getElementById('launcher').style.display = 'flex';
        });

        // --- åˆ›å»º HUD (æŠ¬å¤´æ˜¾ç¤º) ---
        hudContainer = new THREE.Group();
        // Z = -0.3 : æ”¾åœ¨çœ¼ç›æ­£å‰æ–¹ 30 å˜ç±³å¤„
        // Y = -0.05 : ç¨å¾®ä½ä¸€ç‚¹ç‚¹ï¼Œä¸æŒ¡è§†çº¿
        hudContainer.position.set(0, -0.05, -0.3);
        
        // ã€æ ¸å¿ƒé­”æ³•ã€‘æŠŠå®¹å™¨æ·»åŠ ç»™ç›¸æœºï¼Œè€Œä¸æ˜¯åœºæ™¯ï¼
        camera.add(hudContainer);

        // 1. æ·»åŠ ä¸€ä¸ªâ€œç»å¯¹å‚ç…§ç‰©â€ï¼šçº¢è‰²çš„çº¿æ¡†çƒ
        // å¦‚æœä½ è¿è¿™ä¸ªéƒ½çœ‹ä¸è§ï¼Œè¯´æ˜æ˜¾å¡æ²¡æœ‰æ¸²æŸ“
        const debugMesh = new THREE.Mesh(
            new THREE.SphereGeometry(0.05, 16, 16),
            new THREE.MeshBasicMaterial({ 
                color: 0xff0000, 
                wireframe: true,
                depthTest: false // ç¦ç”¨æ·±åº¦æµ‹è¯•ï¼Œä¿è¯å®ƒæ°¸è¿œåœ¨æœ€å‰é¢
            })
        );
        hudContainer.add(debugMesh);

        // 2. æ·»åŠ ç²’å­ç³»ç»Ÿ
        createParticles();

        // 3. æ‰‹éƒ¨è¿½è¸ª (æ‰‹æ˜¯ä¸–ç•Œåæ ‡ï¼Œæ‰€ä»¥åŠ åˆ° sceneï¼Œè€Œä¸æ˜¯ camera)
        hand1 = renderer.xr.getHand(0); scene.add(hand1);
        hand2 = renderer.xr.getHand(1); scene.add(hand2);

        renderer.setAnimationLoop(render);
    }

    function createParticles() {
        const geometry = new THREE.BufferGeometry();
        const positions = [];
        for (let i = 0; i < particleCount; i++) {
            // åœ¨ HUD å®¹å™¨å†…éšæœºåˆ†å¸ƒ
            const x = (Math.random() - 0.5) * 0.2;
            const y = (Math.random() - 0.5) * 0.2;
            const z = (Math.random() - 0.5) * 0.2;
            positions.push(x, y, z);
            particleOriginalPos.push({x, y, z});
        }
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        particleGeo = geometry;

        const material = new THREE.PointsMaterial({
            color: 0x00ffff,
            size: 0.008,
            // ã€å…³é”®è®¾ç½®ã€‘NormalBlending + æ— æ·±åº¦æµ‹è¯• = å¼ºåˆ¶æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚
            blending: THREE.NormalBlending,
            depthTest: false,
            transparent: false 
        });

        particles = new THREE.Points(geometry, material);
        hudContainer.add(particles);
    }

    // è®¡ç®—æ‰‹åŠ¿ (é€»è¾‘ç•¥å¾®ä¿®æ”¹ï¼Œå› ä¸ºç°åœ¨è¦è®¡ç®—æ‰‹ç›¸å¯¹äºç›¸æœºçš„è·ç¦»)
    function getGesture(hand) {
        if (!hand || !hand.joints || !hand.joints['wrist'] || !hand.joints['middle-finger-tip']) return 'neutral';
        
        // è®¡ç®—æ‰‹åŠ¿æœ¬èº«çš„å¼€åˆ
        const d = hand.joints['wrist'].position.distanceTo(hand.joints['middle-finger-tip'].position);
        
        if (d < 0.08) return 'fist';
        if (d > 0.12) return 'palm';
        return 'neutral';
    }

    function render() {
        // è®© HUD é‡Œçš„å‚ç…§çƒè‡ªè½¬ï¼Œè¯æ˜è¿˜æ²¡æ­»æœº
        if(hudContainer.children[0]) {
            hudContainer.children[0].rotation.y += 0.02;
            hudContainer.children[0].rotation.x += 0.01;
        }

        let gesture = 'neutral';
        const g1 = getGesture(hand1);
        const g2 = getGesture(hand2);
        if (g1 !== 'neutral') gesture = g1;
        else if (g2 !== 'neutral') gesture = g2;

        if (particles) {
            const positions = particleGeo.attributes.position.array;
            
            // å˜è‰²é€»è¾‘
            if (gesture === 'palm') particles.material.color.setHex(0xffaa00); // é»„
            else if (gesture === 'fist') particles.material.color.setHex(0xff0055); // çº¢
            else particles.material.color.setHex(0x00ffff); // é’

            // è¿åŠ¨é€»è¾‘
            for(let i=0; i<particleCount; i++) {
                const ix = i * 3;
                const ox = particleOriginalPos[i].x;
                const oy = particleOriginalPos[i].y;
                const oz = particleOriginalPos[i].z;
                
                let scale = 1.0;
                // ç®€å•çš„åŠ¨ç”»æ•ˆæœ
                if (gesture === 'palm') scale = 3.0; // æ”¾å¤§
                if (gesture === 'fist') scale = 0.0; // æ”¶ç¼©

                positions[ix] += (ox * scale - positions[ix]) * 0.1;
                positions[ix+1] += (oy * scale - positions[ix+1]) * 0.1;
                positions[ix+2] += (oz * scale - positions[ix+2]) * 0.1;
            }
            particleGeo.attributes.position.needsUpdate = true;
        }

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
